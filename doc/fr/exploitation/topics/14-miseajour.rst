Déploiement / mises à jour
##########################

.. _CertifAnchor:

Mise à jour des certificats
===========================

Pour mettre à jour les certificats (avant expiration par exemple), il suffit de les mettre à jour dans les répertoires de déploiement, puis de régénerer les stores (dans ``environments/keystores``) et lancer leur redéploiement via cette commande ansible:

Cas où le fichier de mot de passe pour vault n'existe pas ::

    # Si le mot de passe du vault n'est pas renseigné dans le fichier vault_pass.txt
    ansible-playbook ansible-vitam/vitam.yml -i environments/<fichier d'inventaire> --ask-vault-pass --tags update_vitam_certificates
    ansible-playbook ansible-vitam-extra/extra.yml -i environments/<fichier d'inventaire> --ask-vault-pass --tags update_vitam_certificates

Cas où le fichier de mot de passe pour vault existe  ::

    # Si le mot de passe du vault est renseigné dans le fichier vault_pass.txt
    ansible-playbook ansible-vitam/vitam.yml -i environments/<fichier d'inventaire> --vault-password-file vault_pass.txt --tags update_vitam_certificates
    ansible-playbook ansible-vitam-extra/extra.yml -i environments/<fichier d'inventaire> --vault-password-file vault_pass.txt --tags update_vitam_certificates

.. seealso:: Le cycle de vie des certificats est rappelé dans les annexes. Une vue d'ensemble est également présentée dans le :term:`DIN`.


Mise à jour de la solution logicielle VITAM
============================================

Pour la mise à jour de la solution logicielle :term:`VITAM` (tout comme pour sa première installation), se référer au :term:`DIN`, au :term:`DMV`, ainsi qu'à la `release note` associée à toute version.

Ces documents détaillent les pré-requis, la configuration des fichiers et les procédures éventuelles de migration de données pour effectuer une mise à jour applicative. Le :term:`DMV` explique également comment valider une montée de version applicative de la solution logicielle :term:`VITAM`.

.. seealso:: Plus d'informations, et notamment les paramètres d'installation, sont disponibles dans le :term:`DIN`.

.. seealso:: Dans le cadre d'une montée de version, se référer également au :term:`DMV`.

Ajouter un/des instances de composants VITAM
============================================

Dans le cas où le dimensionnement initial ne donne pas pleinement satisfaction, il est possible de rajouter à une solution logicielle :term:`VITAM` existante une/des instances supplémentaires de composants.

.. caution:: Dans le cas d'ajout d'une offre, il est nécessaire de suivre la procédure de resynchronisation des offres.

.. warning:: Seul le composant "vitam-processing" n'est pas multi-instanciable.

.. warning:: Le composant "vitam-workspace" est multi-instanciable, si son répertoire ``/vitam/data/workspace`` est partagé entre les différentes instances du composant. Bien penser, dans ce cas, à la problématique de droits d'accès aux fichiers.


1. Modifier l'inventaire avec la/les VM supplémentaire(s)
2. Lancer un déploiement comme indiqué dans le :term:`DIN` en rajoutant la directive ``-l <liste de/des VM(s) supplémentaire(s)>``

.. _changetimers:

Modifier la fréquence de lancement de certains `timers` systemD
================================================================

Par défaut, la solution logicielle :term:`VITAM` déploie et active, selon l'usage (site primaire / site secondaire), des *timers* systemD.
Le  *playbook* ansible d'installation de vitam ``ansible-vitam/vitam.yml``, permet d'uniquement modifier la fréquence des *timers* en rajoutant le tag ``update_timers_frequency``.

Pour cela, il faut éditer la section ``vitam_timers``  dans le fichier ``environments/group_vars/all/vitam_vars.yml``.

A l'issue, lancer le *playbook* avec la commande ::

    ansible-playbook -i <inventaire> ansible-vitam/vitam.yml --tags update_timers_frequency --ask-vault-pass

ou bien, si vous utilisez le fichier ``vault_pass.txt`` ::

    ansible-playbook -i <inventaire> ansible-vitam/vitam.yml --tags update_timers_frequency --vault-password-file vault_pass.txt
