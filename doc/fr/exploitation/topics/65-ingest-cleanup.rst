.. _ingest_cleanup:

Nettoyage des ingests incomplets
################################

Cette procédure permet de nettoyer les données suite à un ingest incomplet / corrompu.
Elle permet de purger toutes les unités archivistiques, groupes d'objets et objets binaires liés à l'ingest.

Conditions d'éligibilité des ingests à nettoyer
===============================================

L'ingest à nettoyer doit satisfaire les conditions d'éligibilité suivantes :

- L'ingest n'est plus en cours d'exécution (RUNNING ou PAUSE)
- L'ingest s'est terminé avec une erreur (KO ou FATAL)
- Aucune unité d'un autre ingest n'a été rattachée en dessous d'une des unités de l'ingest à nettoyer
- L'ingest à nettoyer n'a pas rajouté d'objets binaires à un groupe d'objets existant
- Aucun autre ingest n'a rajouté d'objets binaires à l'un des groupes d'objets de l'ingest à nettoyer
- L'ingest à nettoyer n'a pas rattaché une unité à un groupe d'objets existant
- Aucun autre ingest n'a rattaché une autre unité à un groupe d'objets de l'ingest à nettoyer

Déclenchement
=============

Le déclenchement se fait de la manière suivante :

.. code-block:: bash

   ansible-playbook ansible-vitam-exploitation/ingest_cleanup.yml -i environments/hosts.<environnement> --ask-vault-pass -e "ingestOperationId=${guid_ingest_a_nettoyer}" -e "tenantId=${tenant}"


Ce playbook s'assure que le composant ``vitam-functional-administration`` est démarré, puis procède au lancement d'un workflow de nettoyage.

.. note:: Cette procédure ne doit être exécutée que pour nettoyer les ingests incomplets / corrompus qui sont éligibles aux conditions d'éligibilité.
