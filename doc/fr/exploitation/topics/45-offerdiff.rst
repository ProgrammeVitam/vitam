.. offer-diff:

Audit comparatif entre 2 offres de stockage miroirs
###################################################

Une offre de stockage peut être désynchronisée par rapport à une autre à la suite d'une indisponibilité plus ou moins longue voire totale de l'offre (`crash` majeur du système, panne matérielle etc.) ou bien encore à la suite d'une mise en maintenance programmée.

Le mécanisme d'audit comparatif entre 2 offres est un audit technique à disposition de l'exploitant. Il permet d'identifier l'ensemble des fichiers désynchronisés entre les 2 offres (existence et size).


Procédure de lancement et de suivi de l'audit comparatif d'offres
=================================================================

Le déclenchement se fait de la manière suivante :

.. code-block:: bash

   ansible-playbook ansible-vitam-exploitation/diff_offers.yml -i environments/${fichier_d_inventaire} --ask-vault-pass -e "offer1=${identifiant de l'offre 1}" -e "offer2=${identifiant de l'offre 2}" -e "container=${container à auditer}" -e "tenantId=${tenant}"


* Le paramètre ``offer1`` spécifie l'identifiant complet de la première offre à comparer (ex. offer-fs-1.service.dc1.consul)
* Le paramètre ``offer2`` spécifie l'identifiant complet de la seconde offre à comparer (ex. offer-fs-2.service.dc2.consul)
* le paramètre ``tenantId`` correspond au tenant sur lequel appliquer la synchronisation
* Le paramètre ``container`` correspond à un élément datatype de la liste suivante :

  .. literalinclude:: ./data/container_list.txt

  Si l'audit comparatif des offres remonte des anomalies, un rapport détaillé est mis à disposition.

* Les journaux de l'audit comparatif se trouvent dans les logs du composant **storage**. Ils peuvent être suivis via la commande suivante:

    .. code-block:: bash

        tail -F /vitam/log/storage/storage_offer_diff.\*.log
