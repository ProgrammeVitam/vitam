Présentation
############

Le composant ``vitam-prometheus`` permet de stocker et visualiser à minima les métriques techniques et métier collectées depuis les différents composants de la solution VITAM. Il permet aussi d'explorer les données en appliquant différentes fonctions statistiques.

Si vous disposez déjà d'une solution de supervision prometheus, il est possible de désactiver son installation avec la solution vitam. Il suffit de modifier la varible ``prometheus.server.enabled: false``. Cette modification permet aussi de désinstaller le serveur prometheus s'il est déjà installé par la solution VITAM.

La solution VITAM, par défaut, déploie une seule instance de ce service. Veuillez vous référer à la documentation officielle prometheus pour pouvoir scaller le déploiement de cet outil.

Générer le fichier de configuration prometheus.yml
==================================================

Dans le cas ou vous disposez d'un serveur prometheus, vous n'avez qu'à générer la configuration ```prometheus.yml`` depuis l'inventaire de l'environnement de la solution VITAM.
Pour générer uniquement la configuration il faut exécuter la ligne de commande suivante :

Depuis le serveur ansible, aller au dossier ``path_to/vitam/deploiement/``

.. code-block:: bash

   # Spécifier le répertoire de sortie dans le fichier cots_var.yml {{ prometheus.prometheus_config_file_target_directory: path_dir_output }}
   ansible-playbook ansible-vitam-extra/prometheus.yml -i environments/hosts.<environnement> --ask-vault-pass --tags gen_prometheus_config

Le fichier de configuration sera généré dans le répertoire de sortie avec le nom ``prometheus.yml``. Il suffit de récupérer les parties nécessaires, comme par exemple ``scrape_configs`` et les intégrer dans la configuration du serveur prometheus déjà existant.

.. warning:: Les flux réseaux entre le serveur prometheus existant et les différents machines hébergeant le solution VITAM doivent être ouverts sur la patte d'administration.


Intégrer de nouvelle règles d'alertes
=====================================

Déposez les fichiers des règles dans le dossier: ``../../../../../../deployment/ansible-vitam-extra/roles/prometheus-server/rules/``
Ensuite lancez la commande suivante:

.. code-block:: bash

   ansible-playbook ansible-vitam-extra/prometheus.yml -i environments/hosts.<environnement> --ask-vault-pass


.. warning:: Si la variable ``prometheus.server.enabled`` dans ``cots_var.yml`` est ``false`` ce playbook n'aura aucun effet.


Exemple de fichiers de règles
-----------------------------

* Règle sur le disque

.. literalinclude:: ../../../../../../deployment/ansible-vitam-extra/roles/prometheus-server/rules/disk.yml
   :language: console

* Règle sur le host

.. literalinclude:: ../../../../../../deployment/ansible-vitam-extra/roles/prometheus-server/rules/host.yml
   :language: console

* Règle sur l'utilisation de la mémoire

.. literalinclude:: ../../../../../../deployment/ansible-vitam-extra/roles/prometheus-server/rules/memory.yml
   :language: console


