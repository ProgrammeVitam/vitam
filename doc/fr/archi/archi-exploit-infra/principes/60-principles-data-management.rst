Gestion des données du système
##############################

.. caution:: Les principes de sauvegarde / restauration présentés dans cette section ne sont pas les principes cibles ; en effet, ils ne peuvent pas convenir dans le cadre de déploiements gérant une quantité massive d'archives. Par conséquent, des principes de sauvegarde et restauration applicatives sont en cours de définition et d'implémentation ; ils consistent majoritairement en la pérennisation des données à ne pas perdre dans les offres de stockage, et seront décrits plus en détails dans une future version de ce document.

Sauvegarde
==========

Vue d'ensemble
--------------

.. caution:: La sauvegarde des données du système se fait à froid dans cette version du système ; par conséquent, une plage d'indisponibilité complète du service est à prévoir (par la suite, cette plage d'indisponibilité sera considérée comme étant la nuit entre 20h00 et 08h00, cette durée pouvant être adaptée en fonction de la volumétrie des sauvegardes à réaliser).

La sauvegarde s'effectue pendant la nuit, avec globalement 5 phases :

- Une phase initiale de suppression des possibilités d'écritures externes dans les bases de données (arrêt des composants frontaux) ;
- Une phase d'attente de la fin des processus internes en cours (workflow d'entrée et sécurisation des journaux) ; cette phase se clôt par l'arrêt ordonné de tous les services VITAM ;
- Une phase d'export des bases de données sous forme de fichiers ;
- Une phase de sauvegarde des fichiers (avec a minima les fichiers d'archives et fichiers d'export des bases de données) ;
- Une phase de redémarrage ordonné des services VITAM.

.. seealso:: Ce processus est décrit plus en détails dans le DEX

.. Mentionner la sauvegarde du système de gestion des logs
.. (mentionner les grandes lignes des principes de stockage / backup / restauration des données)

.. KWA TODO : de manière plus générale, peut-être présenter la même chose pour le cluster Elastic

Principe d'export MongoDB pour une base répartie
------------------------------------------------

.. KWA TODO : OK, ça dit "c'est compliqué" ; et alors ?

La procédure recommandée pour sauvegarder un point temporel d'une base de donnée répartie est complexe et nécessite de nombreux points de synchronisation. Dans le cadre de la sauvegarde à froid, il est préférable de sauvegarder les données directement depuis le serveur principal d'un lot de réplication.

En outre, la méthode de sauvegarde à utiliser doit être adaptée à la volumétrie des bases de données.

Dans les grandes lignes, il faut:

#. Arrêter les services d'entrée **mongos**.
#. Arrêter les services de données **mongod**.
#. Arrêter les services de configuration **mongoc**.
#. Sauvegarder les bases de données **mongod et mongoc**
#. Relancer les services **mongod**
#. Relancer les service **mongoc**
#. Relancer les services d'entrée **mongos**

.. figure:: images/export_mongodb.*
    :align: center

    Vue d'ensemble du processus d'export MongoDB pour base répartie

.. seealso:: Ce processus est décrit plus en détails dans :doc:`la description des besoins en ordonnancement </archi-exploit-infra/10-it-services>`


Dossiers
--------

Les dossiers suivants sont éligibles aux processus de sauvegarde (dans l'ordre décroissant de criticité) :

* ``/vitam/data`` : ce répertoire contenant les données des applications, sa sauvegarde est vitale.
* ``/vitam/tmp`` : la sauvegarde de ce répertoire est optionnelle ; elle peut permettre de diminuer le temps de reprise après incident.
* ``/vitam/conf`` : la sauvegarde de la configuration est normalement peu utile, car tous les fichiers de configuration sont gérés par ansible, donc facilement réinstanciables.

Les autres répertoires sont intégralement fournis par les packages d'installation ; leur sauvegarde n'est donc pas indispensable.

.. Utilisation des outils fournis (ex: mongodump pour la sauvegarde de mongo) à aborder dans la description des services (dans l'architecture technique)


Restauration
============

La procédure de restauration s'appuie sur le postulat que le système VITAM est dans un état incohérent au début de celle-ci.

1. S'assurer que tous les services VITAM sont arrêtés.

  * Arrêter les services subsistant.

2. Restaurer les dossiers précédemment sauvegardés à leur emplacement respectif.
3. Démarrer les services suivant la procédure de démarrage VITAM.
