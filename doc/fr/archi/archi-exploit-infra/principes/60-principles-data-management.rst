Gestion des données du système
##############################

Dans VITAM, les principes de sauvegarde / restauration utilisés de manière classique ne peuvent être appliqués ; en effet, ils ne peuvent pas convenir dans le cadre de déploiements gérant une quantité massive d'archives. Par conséquent, des principes de sauvegarde et restauration applicatives particuliers sont mis en place dans le cadre de la solution, principalement basés sur l'utilisation des offres de stockage afin d'assurer la pérennisation des données.

VITAM doit être reconstructible à partir de 2 éléments qui sont :

* Les données persistées dans les offres de stockage ;
* La configuration & les données (notamment les secrets) de déploiement. Ces secrets incluent notamment les certificats (et notamment les certificats clients des applications externes et des personae).

.. seealso:: La reconstruction et la vision applicative des données est abordée à la section :doc:`/archi-applicative/11-data-architecture-multisite`.


Cas des déploiements de petite taille
=====================================

Dans le cas de déploiement de petite taille, il est possible d'effectuer une sauvegarde classique du système, à froid.

Dossiers
--------

Les dossiers suivants sont éligibles aux processus de sauvegarde (dans l'ordre décroissant de criticité) :

* ``/vitam/data`` : ce répertoire contenant les données des applications, sa sauvegarde est vitale.
* ``/vitam/tmp`` : la sauvegarde de ce répertoire est optionnelle ; elle peut permettre de diminuer le temps de reprise après incident.
* ``/vitam/conf`` : la sauvegarde de la configuration est normalement peu utile, car tous les fichiers de configuration sont gérés par ansible, donc facilement réinstanciables.

Les autres répertoires sont intégralement fournis par les packages d'installation ; leur sauvegarde n'est donc pas indispensable.


Sauvegarde
----------


La sauvegarde s'effectue pendant la nuit, avec globalement 5 phases :

1. Une phase initiale de suppression des possibilités d'écritures externes dans les bases de données (arrêt des composants frontaux) ;
2. Une phase d'attente de la fin des processus internes en cours (workflow d'entrée et sécurisation des journaux) ; cette phase se clôt par l'arrêt ordonné de tous les services VITAM ;
3. Une phase d'export des bases de données sous forme de fichiers ;
4. Une phase de sauvegarde des fichiers (avec a minima les fichiers d'archives et fichiers d'export des bases de données) ;
5. Une phase de redémarrage ordonné des services VITAM.


Restauration
============

La procédure de restauration s'appuie sur le postulat que le système VITAM est dans un état incohérent au début de celle-ci.

1. S'assurer que tous les services VITAM sont arrêtés.
2. Restaurer les dossiers précédemment sauvegardés à leur emplacement respectif.
3. Démarrer les services suivant la procédure de démarrage VITAM.

.. note:: La sauvegarde / restauration des bases MongoDB et Elasticsearch (data et logs) n'est pas indispensable. A contrario, la sauvegarde / restauration des bases MongoDB des offres, et notamment les offres froides (stockage sur bande) est fortement recommandée ; des détails sont fournis dans le :term:`DEX`.

