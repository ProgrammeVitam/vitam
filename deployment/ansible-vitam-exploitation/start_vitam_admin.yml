---

- hosts: hosts_consul_server
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'consul' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-consul

- hosts: vitam
  gather_facts: no
  roles:
    - { role: service, when: "groups['hosts_elasticsearch_log'] | length > 0" }
  vars:
    service_state: started
    service_name: metricbeat
  tags: metricbeat

- hosts: vitam
  any_errors_fatal: true
  gather_facts: no
  roles:
    - { role: service, when: consul_disabled is not defined or consul_disabled |lower != 'true' }
  vars:
    service_state: "{% if 'consul' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-consul

# Monitoring
- hosts: hosts_prometheus
  gather_facts: no
  roles:
    - service
  vars:
    service_state: started
    service_name: vitam-prometheus

- hosts: vitam
  gather_facts: no
  roles:
    - { role: service, when: "( prometheus.node_exporter.enabled == true )" }
  vars:
    service_state: started
    service_name: vitam-node-exporter

- hosts: hosts_alertmanager
  gather_facts: no
  roles:
    - service
  vars:
    service_state: started
    service_name: vitam-alertmanager

- hosts: hosts_grafana
  gather_facts: no
  roles:
    - service
  vars:
    service_state: started
    service_name: grafana-server

# log-central start
- hosts: hosts_cerebro
  gather_facts: no
  roles:
    - service
  vars:
    service_state: started
    service_name: vitam-elasticsearch-cerebro

- hosts: hosts_elasticsearch_log
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'elasticsearch-log' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-elasticsearch-log
    service_host: "{{ ip_admin }}"
    service_port: "{{ elasticsearch.log.port_http }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_logstash
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'logstash' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: logstash
    service_host: "{{ ip_admin }}"
    service_port: "{{ logstash.port }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_kibana_log
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'kibana' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: kibana
    service_host: "{{ ip_admin }}"
    service_port: "{{ kibana.log.port }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_mongos_data
  roles:
    - { role: docker, when: "(inventory_hostname not in single_vm_hostnames) and (docker_install | lower == 'true')" }
  vars:
    container_name: "mongo-express"
    container_state: started
    container_group: "hosts_mongos_data"

- hosts: hosts_mongos_offer
  roles:
    - { role: docker, when: "(inventory_hostname not in single_vm_hostnames) and (docker_install | lower == 'true')" }
  vars:
    container_name: "mongo-express"
    container_state: started
    container_group: "hosts_mongos_offer"

- hosts: hosts_dev_tools
  roles:
    - { role: docker, when: "(inventory_hostname not in single_vm_hostnames) and (docker_install | lower == 'true')" }
  vars:
    container_name: "elasticsearch-head"
    container_state: started

- hosts: library
  gather_facts: no
  roles:
    - service
  vars:
    service_state: started
    service_name: vitam-library
    service_host: "{{ ip_admin }}"
    service_port: "{{ vitam.library.port_admin }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"
