---
# Example: ansible-vitam-exploitation/diff_offers.yml -e "confirmation=YES offer1=offer-fs-1.service.prod-dc1.consul offer2=offer-fs-2.service.prod-dc2.consul tenantId=0 container=units"
# Doc: http://www.programmevitam.fr/ressources/DocCourante/html/exploitation/topics/45-offerdiff.html

# Confirm launching this playbook
- hosts: localhost
  gather_facts: no
  any_errors_fatal: yes
  vars_prompt:
    name: "confirmation"
    prompt: "This playbook will execute a check between two offers on the selected tenant & container.\n/!\\ WARNING : This execution will use disk space on the first hosts_storage_engine.\n\nAre you sure you want to run this playbook?\nAnswer with 'YES' / 'NO'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

- hosts: hosts_storage_engine
  gather_facts: no
  run_once: true
  tasks:
  - name: "Available offers"
    debug:
      msg: "{{ item.name }}.service.{{ item.vitam_site_name | default(vitam_site_name) }}.{{ consul_domain }}"
    loop: "{{ vitam_strategy }}"

- hosts: hosts_storage_engine
  any_errors_fatal: yes
  gather_facts: no
  run_once: true
  vars_prompt:
    - name: "offer1"
      prompt: "Please select offer1"
      private: no
    - name: "offer2"
      prompt: "Please select offer2"
      private: no
    - name: "tenantId"
      prompt: "Please select tenantId"
      private: no
  tasks:
    - name: "Check offer1"
      assert:
        that:
          - offer1 is defined and offer1 != ''
    - name: "set_fact offer1"
      set_fact:
        offer1: "{{ offer1 }}"

    - name: "Check offer2"
      assert:
        that:
          - offer2 is defined and offer2 != '' and offer2 != offer1
    - name: "set_fact offer2"
      set_fact:
        offer2: "{{ offer2 }}"

    - name: "Check tenantId"
      assert:
        that:
          - tenantId is match('^[0-9]+$')
    - name: "Check tenantId in vitam_tenant_ids"
      fail: msg="Invalid tenantId {{ tenantId }} not in {{ vitam_tenant_ids }}."
      when: tenantId|int not in vitam_tenant_ids
    - name: "set_fact tenantId"
      set_fact:
        tenantId: "{{ tenantId }}"

- hosts: hosts_storage_engine
  gather_facts: no
  run_once: true
  tasks:
  - name: "Available containers"
    debug:
      msg: "{{ containers_list }}"

- hosts: hosts_storage_engine
  any_errors_fatal: yes
  gather_facts: no
  run_once: true
  vars_prompt:
    - name: "container"
      prompt: "Please select container"
      private: no
  tasks:
    - name: "Check container"
      fail: msg="Invalid container {{ container }} not in {{ containers_list }}."
      when: container not in containers_list
    - name: "set_fact container"
      set_fact:
        container: "{{ container }}"

- hosts: hosts_storage_engine
  any_errors_fatal: yes
  roles:
    - diff_offers
  vars:
    vitam_struct: "{{ vitam.storageengine }}"
  run_once: true
