---
# Doc: http://www.programmevitam.fr/ressources/DocCourante/html/exploitation/topics/17-backup_restore_gros_volume.html#cas-particulier-de-l-offre-froide

# Confirm launching this playbook
- hosts: localhost
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: "confirmation"
    prompt: "/!\\ WARNING : This playbook will stop your Vitam instance and it must be executed only if you have a tape offer defined.\n\nAre you sure you want to run this playbook ?\nAnswer with 'YES'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

# Prompt for target offer name
- hosts: localhost
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    - name: "offerName"
      prompt: "Please select offer name (as described in offer offer_conf in hosts file)"
      private: no
  tasks:
    - name: "Check offerName"
      assert:
        that:
          - offerName is defined and offerName != ''
    - name: "set_fact offerName"
      set_fact:
        offerName: "{{ offerName }}"

# Detect master mongodb nodes
- hosts: hosts_mongod_offer
  roles:
    - tape_offer_backup_init_time_var

- hosts: hosts_mongod_offer
  gather_facts: no
  roles:
    - mongodb_is_master
  vars:
    - mongo_type: "mongod"
    - mongo_port: "{{ mongodb.mongod_port }}"

- hosts: hosts_mongoc_offer
  gather_facts: no
  roles:
    - mongodb_is_master
  vars:
    - mongo_type: "mongoc"
    - mongo_port: "{{ mongodb.mongoc_port }}"

# Stop vitam
- import_playbook: stop_vitam.yml

# Backup mongodb directory
- hosts: hosts_mongod_offer
  gather_facts: no
  roles:
    - { role: backup_tape_offer, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongod_is_master'] == true ) and (mongo_cluster_name == hostvars['localhost']['offerName'])" }
  vars:
    - mongo_type: "mongod"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongod-shard{{ mongo_shard_id }}.zip"

- hosts: hosts_mongoc_offer
  gather_facts: no
  roles:
    - { role: backup_tape_offer, when: "( mongo_offer_provider == 'tape-library' ) and ( mongoc_is_master == true ) and (mongo_cluster_name == hostvars['localhost']['offerName'])" }
  vars:
    - mongo_type: "mongoc"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongoc-shard0.zip"

# Start mongodb
- import_playbook: start_mongodb.yml

# Start tape offer
- hosts: hosts_storage_offer_default
  gather_facts: no
  any_errors_fatal: true
  roles:
    - { role: service, when: "vitam_offers[offer_conf].provider == 'tape-library' and (offer_conf == hostvars['localhost']['offerName'])" }
  vars:
    service_state: "{% if 'offer' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-offer
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.storageofferdefault.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

# Post backup zip
- hosts: hosts_mongod_offer
  gather_facts: no
  roles:
    - { role: send_offer_backup_to_tape, when: "( mongo_offer_provider == 'tape-library' ) and ( mongod_is_master == true ) and (mongo_cluster_name == hostvars['localhost']['offerName'])" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongod-shard{{ mongo_shard_id }}.zip"

- hosts: hosts_mongoc_offer
  gather_facts: no
  roles:
    - { role: send_offer_backup_to_tape, when: "( mongo_offer_provider == 'tape-library' ) and ( mongoc_is_master == true ) and (mongo_cluster_name == hostvars['localhost']['offerName'])" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongoc-shard0.zip"

# Start vitam
- import_playbook: start_vitam.yml
