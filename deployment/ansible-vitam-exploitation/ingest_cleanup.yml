---
# Example: ansible-vitam-exploitation/ingest_cleanup.yml -e "confirmation=YES ingestOperationId=aeeaaaaaachip46daa4s4alxh7ji24iaaaaq tenantId=0"
# Doc: http://www.programmevitam.fr/ressources/DocCourante/html/exploitation/topics/65-ingest-cleanup.html

# Confirm launching this playbook
- hosts: localhost
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: "confirmation"
    prompt: "/!\\ WARNING : PLEASE RUN THIS SCRIPT ONLY FOR CLEANING A CORRUPTED INGEST OPERATION THAT IT IS ELIGIBLE FOR CLEANUP.\n\nAre you sure you want to run this playbook ?\nAnswer with 'YES' / 'NO'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

- hosts: hosts_functional_administration
  any_errors_fatal: yes
  gather_facts: no
  run_once: true
  vars_prompt:
    name: "ingestOperationId"
    prompt: "Please select ingestOperationId"
    private: no
  tasks:
    - name: "Check ingestOperationId"
      assert:
        that:
          - ingestOperationId is match('^[a-z0-9]{36}$')
    - name: "set_fact ingestOperationId"
      set_fact:
        ingestOperationId: "{{ ingestOperationId }}"

- hosts: hosts_functional_administration
  any_errors_fatal: yes
  gather_facts: no
  run_once: true
  vars_prompt:
    name: "tenantId"
    prompt: "Please select tenantId"
    private: no
  tasks:
    - name: "Check tenantId"
      assert:
        that:
          - tenantId is match('^[0-9]+$')
    - name: "Check tenantId in vitam_tenant_ids"
      fail: msg="Invalid tenantId {{ tenantId }} not in {{ vitam_tenant_ids }}."
      when: tenantId|int not in vitam_tenant_ids
    - name: "set_fact tenantId"
      set_fact:
        tenantId: "{{ tenantId }}"

# Run
- hosts: hosts_functional_administration
  roles:
    - ingest_cleanup
