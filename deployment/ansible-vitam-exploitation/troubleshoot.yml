---

# Confirm launching this playbook
- hosts: all
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: "confirmation"
    prompt: "Are you sure you want to run this playbook? Answer with 'YES'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

- hosts: all
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: log_files_age
    prompt: "Type the maximum age of the files you want to retrieve (in days)"
    default: 2
    private: no
  tasks:
    - name: Age check
      fail: msg="Files age not valid"
      when: log_files_age| int == 0
    - name: Register var
      set_fact:
        log_files_age: "{{ log_files_age }}"

- hosts: all
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: sync_type
    prompt: "Select the sync method to use between hosts & ansible controller to retrieve files ? (rsync/fetch)"
    default: "rsync"
    private: no
  tasks:
    - name: rsync
      fail: msg="sync method available is 'rsync' or 'fetch'"
      when: sync_type not in ['rsync','fetch']
    - name: Register var
      set_fact:
        sync_type: "{{ sync_type }}"

# Init troubleshoot
- hosts: vitam
  roles:
    - init_troubleshoot
    - gather_host
    - resolvconf
    - tree_deployment
    - check_parent_structure

# get consul state
- hosts: hosts_consul_server
  roles:
    - consul_state

# fetch logs
- hosts: hosts_storage_offer_default
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.storageofferdefault }}"
    age: "{{ log_files_age }}"

- hosts: hosts_storage_engine
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.storageengine }}"
    age: "{{ log_files_age }}"

- hosts: hosts_metadata
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.metadata }}"
    age: "{{ log_files_age }}"

- hosts: hosts_batch_report
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.batchreport }}"
    age: "{{ log_files_age }}"

- hosts: hosts_logbook
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.logbook }}"
    age: "{{ log_files_age }}"

- hosts: hosts_workspace
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.workspace }}"
    age: "{{ log_files_age }}"

- hosts: hosts_functional_administration
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.functional_administration }}"
    age: "{{ log_files_age }}"

- hosts: hosts_security_internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.security_internal }}"
    age: "{{ log_files_age }}"

- hosts: hosts_processing
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.processing }}"
    age: "{{ log_files_age }}"

- hosts: hosts_worker
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.worker }}"
    age: "{{ log_files_age }}"

- hosts: hosts_access_internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.accessinternal }}"
    age: "{{ log_files_age }}"

- hosts: hosts_access_external
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.accessexternal }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ingest_internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.ingestinternal }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ingest_external
  any_errors_fatal: true
  roles:
    - vitam_log_files
   #- {role: clamav, when: vitam_struct.antivirus=='clamav' }
  vars:
    vitam_struct: "{{ vitam.ingestexternal }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ihm_demo
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.ihm_demo }}"
    age: "{{ log_files_age }}"

# Get elasticsearch info
- hosts: hosts_elasticsearch_log
  roles:
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.log }}"
    age: "{{ log_files_age }}"

- hosts: hosts_elasticsearch_data
  roles:
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.data }}"
    age: "{{ log_files_age }}"

- hosts: vitam
  any_errors_fatal: yes
  vars_prompt:
    name: "get_crt"
    prompt: "Can we copy your crt files (YES/NO) ?"
    default: "NO"
    private: no
  roles:
    - {role: get_crt_files, when: get_crt|upper == "YES"}

- hosts: vitam
  roles:
    - end_troubleshoot
