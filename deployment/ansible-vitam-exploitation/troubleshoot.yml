---
# Example: ansible-vitam-exploitation/troubleshoot.yml -e 'confirmation=YES log_files_age=2'
# Optional parameters: -e 'sync_type=rsync get_crt=yes excludes=gc*,access*'
# Doc: http://www.programmevitam.fr/ressources/DocCourante/html/exploitation/troubleshoot/analyse.html#playbook-ansible-pour-echanger-avec-le-support

# Confirm launching this playbook
- hosts: localhost
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: "confirmation"
    prompt: "This playbook will collect logs and other useful information to help debugging your Vitam instance.\n\nAre you sure you want to run this playbook ?\nAnswer with 'YES'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation | default(false) | bool == false
      tags: always
  run_once: true

- hosts: all
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: log_files_age
    prompt: "Type the maximum age of the files you want to retrieve (in days)"
    default: 2
    private: no
  tasks:
    - name: Age check
      fail:
        msg: "log_files_age is not valid: {{ log_files_age }} <= 0"
      when: log_files_age | int <= 0
    - name: Register var
      set_fact:
        log_files_age: "{{ log_files_age }}"
  run_once: true

# Init troubleshoot
- hosts: vitam
  gather_facts: no
  roles:
    - init_troubleshoot
    - gather_host
    - resolvconf
    - tree_deployment
    - check_parent_structure

# get consul state
- hosts: hosts_consul_server
  gather_facts: no
  ignore_errors: true
  roles:
    - consul_state

# fetch logs
- hosts: hosts_storage_offer_default
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.storageofferdefault.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_storage_engine
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.storageengine.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_metadata
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.metadata.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_batch_report
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.batchreport.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_logbook
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.logbook.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_workspace
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.workspace.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_functional_administration
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.functional_administration.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_security_internal
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.security_internal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_processing
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.processing.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_worker
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.worker.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_access_internal
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.accessinternal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_access_external
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.accessexternal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ingest_internal
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.ingestinternal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ingest_external
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
   #- {role: clamav, when: vitam_struct.antivirus=='clamav' }
  vars:
    component_name: "{{ vitam.ingestexternal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_ihm_demo
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.ihm_demo.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_collect_internal
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.collect_internal.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_collect_external
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.collect_external.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_metadata_collect
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.metadata_collect.vitam_component }}"
    age: "{{ log_files_age }}"

- hosts: hosts_workspace_collect
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
  vars:
    component_name: "{{ vitam.workspace_collect.vitam_component }}"
    age: "{{ log_files_age }}"

# Get elasticsearch info
- hosts: hosts_elasticsearch_log
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.log }}"
    component_name: "{{ elasticsearch.log.cluster_name }}"
    age: "{{ log_files_age }}"

- hosts: hosts_elasticsearch_data
  gather_facts: no
  ignore_errors: true
  roles:
    - vitam_log_files
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.data }}"
    component_name: "{{ elasticsearch.data.cluster_name }}"
    age: "{{ log_files_age }}"

- hosts: vitam
  gather_facts: no
  ignore_errors: true
  roles:
    - { role: get_crt_files, when: get_crt | default(false) | bool == true }

- hosts: vitam
  gather_facts: no
  roles:
    - end_troubleshoot
