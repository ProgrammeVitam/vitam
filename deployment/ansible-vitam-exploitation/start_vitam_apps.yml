---

- import_playbook: start_mongodb.yml

- import_playbook: start_elasticsearch_data.yml

- hosts: hosts_kibana_data
  gather_facts: no
  any_errors_fatal: true
  roles:
    - service
  vars:
    service_state: "{% if 'elastic-kibana-interceptor' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-elastic-kibana-interceptor
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.elastickibanainterceptor.port_service }}"
    service_timeout: "{{ vitam_defaults.services.stop_timeout }}"

- hosts: hosts_kibana_data
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'kibana' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: kibana
    service_host: "{{ ip_service }}"
    service_port: "{{ kibana.data.port }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_storage_offer_default
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'offer' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-offer
    #vitam_struct: "{{ vitam.storageofferdefault }}"
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.storageofferdefault.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_storage_engine
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'storage' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    vitam_struct: "{{ vitam.storageengine }}"
    service_name: vitam-storage
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.storageengine.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_metadata
  serial: 1
  gather_facts: no
  any_errors_fatal: true
  roles:
    - service
  vars:
    service_state: "{% if 'metadata' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-metadata
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.metadata.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_workspace
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'workspace' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-workspace
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.workspace.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_logbook
  serial: 1
  gather_facts: no
  any_errors_fatal: true
  roles:
    - service
  vars:
    service_state: "{% if 'logbook' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-logbook
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.logbook.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_functional_administration
  serial: 1
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'functional-administration' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-functional-administration
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.functional_administration.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_security_internal
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'security-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-security-internal
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.security_internal.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_processing
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'processing' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-processing
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.processing.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_batch_report
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'batchreport' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-batch-report
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.batchreport.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_worker
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'siegfried' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-siegfried

- hosts: hosts_worker
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'worker' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-worker
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.worker.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- import_playbook: start_vitam_collect.yml

- hosts: hosts_access_internal
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'access-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-access-internal
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.accessinternal.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_ingest_internal
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'ingest-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-ingest-internal
    service_host: "{{ ip_service }}"
    service_port: "{{ vitam.ingestinternal.port_service }}"
    service_timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts_ingest_external
  any_errors_fatal: true
  gather_facts: no
  roles:
    - service
  vars:
    service_state: "{% if 'siegfried' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    service_name: vitam-siegfried

- import_playbook: start_external.yml

- import_playbook: start_vitam_ihm.yml

- import_playbook: ../ansible-vitam/internal_start_vitam_timers.yml
