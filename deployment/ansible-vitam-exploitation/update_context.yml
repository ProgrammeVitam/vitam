---

# Example: ansible-playbook -i environment/<hosts_file> ansible-vitam-exploitation/update_context.yml --vault-password-file password_file.txt -e security_profile_id="<your_sp_to_update"
# Doc: http://www.programmevitam.fr/ressources/DocCourante/html/exploitation/topics/18-securityprofile.html#ajout-de-profils-de-securite

# Confirm launching this playbook
- hosts: localhost
  any_errors_fatal: yes
  gather_facts: no
  vars_prompt:
    name: "confirmation"
    prompt: "This playbook will update the security-profile [{{ security_profile_id }}] defined in environments/group_vars/all/postinstall_param.yml. YOU CAN ONLY ADD DIFFERENT CERTIFICATES !\n\nAre you sure you want to run this playbook ?\nAnswer with 'YES'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

- hosts: hosts_mongos_data
  gather_facts: no
  roles:
    - { role: context_and_security_profiles, when: primary_site | lower == "true" }
  vars:
    action_ctx: "list"
  run_once: true

- hosts: hosts_security_internal
  gather_facts: yes
  any_errors_fatal: true
  roles:
    - { role: context_and_security_profiles, when: primary_site | lower == "true" }
  vars:
    vitam_struct: "{{ vitam.security_internal }}"
    action_ctx: "update"
  run_once: true
