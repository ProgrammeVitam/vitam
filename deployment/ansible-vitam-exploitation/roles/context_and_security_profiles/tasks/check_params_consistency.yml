---

- name: "install json query filter"
  import_tasks: "install_filter.yml"

- set_fact:
    admin_context_found: 0

- name: Parameters from postinstall_param.yml
  debug:
    var: vitam_additional_securityprofiles

- name: Check parameters from postinstall_param.yml
  set_fact:
    admin_context_found: "{{ admin_context_found|int + ( 1 if item.contexts|join is search('admin-context') == true else 0 )|int }}"
  loop: "{{ vitam_additional_securityprofiles }}"

- fail:
    msg: "admin-context should not be update by this playbook !!! Change your postinstall_param.yml"
  when:  admin_context_found|int > 0

- name: "Check parameters from postinstall_param.yml for {{ security_profile_id }}"
  vars:
    jmesquery: "[? identifier==`{{ security_profile_id }}`]"
  set_fact:
    security_profile_content_found: "{{ vitam_additional_securityprofiles | json_query(jmesquery) }}"

- fail:
    msg: "Context {{ security_profile_id }} doesn't exist in postinstall_param.yml ! Change your postinstall_param.yml."
  when: security_profile_content_found|length == 0 and security_profile_id|length > 0
