---

- include_tasks: get_context_information.yml

- name: Modify json & convert to dict...
  set_fact:
    context_check_json: "{{ context_check.json |regex_replace('\\$hits', 'hits')|regex_replace('\\$results', 'results')|regex_replace('#', '') }}"
  run_once: true

- block:
  - name: Copy temporary script to delete certificates on groups['hosts_mongos_data'] associated to contexts (that are related to the context {{ context.identifier }})
    template:
      src: "delete_certificates.js.j2"
      dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongos/delete_certificates_{{ context.identifier }}.js"
      owner: "{{ vitam_defaults.users.vitamdb }}"
      group: "{{ vitam_defaults.users.group }}"
      mode: "{{ vitam_defaults.folder.conf_permission }}"
    delegate_to: "{{ groups['hosts_mongos_data'] | first }}"

  - name: Delete in mongo certificates (mongo query) linked to the context {{ context.identifier }}.
    shell: "mongo {{ hostvars[groups['hosts_mongos_data'][0]]['ip_service'] }}:{{ mongodb.mongos_port }}/admin -u {{ mongodb['mongo-data'].admin.user }} -p {{ mongodb['mongo-data'].admin.password }} --quiet {{ vitam_defaults.folder.root_path }}/tmp/mongos/delete_certificates_{{ context.identifier }}.js"
    delegate_to: "{{ groups['hosts_mongos_data'] | first }}"
    no_log: "{{ hide_passwords_during_deploy }}"

  - name: Remove temporary script to delete certificates associated to the context {{ context.identifier }}.
    file:
      path: "{{ vitam_defaults.folder.root_path }}/tmp/mongos/delete_certificates_{{ context.identifier }}.js"
      state: absent
    delegate_to: "{{ groups['hosts_mongos_data'] | first }}"
    run_once: true

  - name: Delete context {{ context.identifier }}.
    uri:
      method: DELETE
      status_code: 200,201,204
      url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/v1/admin/context/{{ context.identifier }}"
  when: context_check_json.hits.total > 0
