---

- include_tasks: check_security_profile_exist.yml

- name: Modify json & convert to dict...
  set_fact:
    securityprofile_check_json: "{{ securityprofile_check.json |regex_replace('\\$hits', 'hits')|regex_replace('\\$results', 'results')|regex_replace('\\#id', 'id') }}"
  run_once: true

- debug:
    msg: "There is no security profile that matches post_install_param.yml informations ({{ security_profile.identifier }})"
  when: securityprofile_check_json.hits.total == 0

- debug:
    msg: "Security profile [{{ security_profile.identifier }}] will be deleted."
  when: securityprofile_check_json.hits.total > 0

- block:

  - name: Remove contexts and certificates linked to the security profile {{ security_profile.identifier }}
    include_tasks: delete_certificates_contexts.yml
    loop: "{{ security_profile.contexts }}"
    loop_control:
      loop_var: context

  - name: Delete security profile {{ security_profile.identifier }}
    uri:
      method: DELETE
      status_code: 200,204
      url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/v1/admin/securityprofiles/{{ security_profile.identifier }}"
    run_once: true

  when: securityprofile_check_json.hits.total > 0
