var embeddedSecurityProfilesContextsAndCertificates= [];
db.getSiblingDB('masterdata').SecurityProfile.aggregate([
    {
    $lookup: {
        from: "Context",
        localField: "Identifier",
        foreignField: "SecurityProfile",
        as: "contextsList"
    }
}]).forEach(securityProfile => {
    contextsList = securityProfile.contextsList;
    if(contextsList){
        contextsList.forEach(context => {
           certificates= [];
           db.getSiblingDB('identity').Certificate.find({
               "ContextId": context.Identifier
           }).forEach(certificat => {

	    {% if showEncodedCertificate != "true" %}
	    delete certificat.Certificate;
	    {% endif %}

            certificates.push(certificat);

           })
           context.certificatesList  =certificates
        })
        embeddedSecurityProfilesContextsAndCertificates.push(JSON.stringify((securityProfile)));
    }
});

print("["+embeddedSecurityProfilesContextsAndCertificates+"]");
