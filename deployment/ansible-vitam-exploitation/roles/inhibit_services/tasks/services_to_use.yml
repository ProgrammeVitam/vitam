---

- name: Get vitam services primary
  shell: grep "vitam_component" {{ inventory_dir }}/group_vars/all/vitam_vars.yml | cut -d ':' -f2 | cut -d ' ' -f2 | cut -d '"' -f2 | cut -d '"' -f1
  register: vitam_services_primary
  delegate_to: localhost

- name: Get vitam services secondary
  shell: grep "vitam_secondary_site_components" {{ inventory_dir }}/group_vars/all/vitam_vars.yml | sed 's/" , "/\n/g; s/", "/\n/g; s/\[ "//g; s/" \]/\n/g; s/:\ /\n/g' | grep -v "vitam_secondary_site_components"
  register: vitam_services_secondary
  delegate_to: localhost

- name: Concatenate lists
  set_fact:
    services_list: "{{ vitam_services_primary.stdout_lines + vitam_services_secondary.stdout_lines | sort | unique }}"
  register: value

# Custom list
- block:

  - set_fact:
      customlist: "{{ list_services }}"

  - set_fact:
      services_list_count: "{{ value.ansible_facts.services_list | unique | length }}"
      appendlist: "{{ value.ansible_facts.services_list + customlist }}"

  - set_fact:
      appendlist_count: "{{ appendlist | unique | length }}"

  - name: Check custom list validity
    fail:
      msg: "The custom list is incorrect"
    when: appendlist_count != services_list_count

  - debug:
      msg: "The custom list is correct"
    when: appendlist_count == services_list_count

  - set_fact:
      services_list: "{{ list_services }}"

  when: list_services != "all"
