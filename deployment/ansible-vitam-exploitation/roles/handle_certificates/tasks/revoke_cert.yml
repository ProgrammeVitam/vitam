---

- fail:
    msg: "CRL file path is empty. You should pass -e crl_file='<crl_file_path>' to the playbook !!!"
  when: crl_file | default('') | length == 0

- name: Show CRL content
  debug:
    msg: "{{ lookup('file', '{{ crl_file }}') }}"
  delegate_to: localhost

- name: "Apply the CRL to your Vitam environment"
  pause:
    prompt: "Are you sure you want to execute this action ?\nAnswer with 'YES'"
  register: exec_action

- name: Apply CRL to Vitam
  uri:
    method: POST
    force_basic_auth: yes
    user: "{{ admin_basic_auth_user }}"
    password: "{{ admin_basic_auth_password }}"
    url: "http://{{ hostvars[groups['hosts_security_internal'][0]]['ip_admin'] }}:{{vitam.security_internal.port_admin}}/v1/api/crl"
    body: "{{ lookup('file','{{ crl_file }}') }}"
    status_code: 204
    timeout: "{{ vitam_defaults.services.api_call_timeout }}"
    headers:
      Content-Type: "application/octet-stream"
  when: exec_action.user_input == "YES"
