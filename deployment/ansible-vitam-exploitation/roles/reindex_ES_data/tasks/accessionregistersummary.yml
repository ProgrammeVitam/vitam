---
- set_fact:
    # FunctionalAdminCollections.ACCESSION_REGISTER_SUMMARY
    cas: "ACCESSION_REGISTER_SUMMARY"

#curl -X POST -k --key ./vitam-vitam_1.key --cert ./vitam-vitam_1.pem  'https://int.env.programmevitam.fr/admin-external/v1/reindex' -H 'X-Tenant-Id: 0' -H 'X-Access-Contract-Id: ContratTNR' -H 'Content-Type: application/json;charset=UTF-8' -H 'Accept: application/json' --data-binary '[{"collection" : "CONTEXT", "tenants" : []}]' --compressed
- name: reindexing ES for {{ cas }}
  uri:
    url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/adminmanagement/v1/reindex"
    method: POST
    headers:
      Connection: "keep-alive"
      X-Tenant-Id: "{{ vitam_tenant_ids|first }}"
    body: "[{\"collection\" : \"{{ cas }}\", \"tenants\" : []}]"
    body_format: "json"
    validate_certs: false
    return_content: yes
    status_code: 201, 202
    timeout: "36000"
  register: reindex
  run_once: true

- name: Modify json for {{ cas }}
  set_fact:
    reindexes: "{{ reindex.json |regex_replace('\\$results', 'results') }}"
  run_once: true
    
#curl -X POST -k --key ./vitam-vitam_1.key --cert ./vitam-vitam_1.pem  'https://int.env.programmevitam.fr/admin-external/v1/alias' -H 'X-Tenant-Id: 0' -H 'X-Access-Contract-Id: ContratTNR' -H 'Content-Type: application/json;charset=UTF-8' -H 'Accept: application/json' --data-binary '[{"alias" : "context", "indexName" : "context_20180117_103040"}]' --compressed
- name: re-aliasing ES for {{ cas }}
  uri:
    url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/adminmanagement/v1/alias"
    method: POST
    headers:
      Connection: "keep-alive"
      X-Tenant-Id: "{{ item.tenant }}"
    body: "[{\"alias\" : \"{{ reindexes.results[0].collectionName }}\", \"indexName\" : \"{{ item.indexName }}\"}]"
    body_format: "json"
    validate_certs: false
    return_content: yes
    #status_code: 201, 202
    timeout: "36000"
  with_items:
    - "{{ reindexes.results[0].OK }}"
  run_once: true
#curl -X POST -k --key ./vitam-vitam_1.key --cert ./vitam-vitam_1.pem  'https://int.env.programmevitam.fr/admin-external/v1/alias' -H 'X-Tenant-Id: 0' -H 'X-Access-Contract-Id: ContratTNR' -H 'Content-Type: application/json;charset=UTF-8' -H 'Accept: application/json' --data-binary '[{"alias" : "context", "indexName" : "context_20180117_103040"}]' --compressed
