---
- name: ensure {{ inventory_dir }}/troubleshoot/{{ inventory_hostname }} exists to get back log files
  local_action:
    module: file
    path: "{{ inventory_dir }}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.vitam_component }}"
    state: directory
    mode: 0777

- name: list files from {{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.vitam_component }}
  find:
    paths: "{{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.vitam_component }}"
    age: "-{{ age }}d"
    recurse: no # no subdir
    file_type: file
  register: path_files

- block:

  - name: ensure rsync package is installed for synchronize module
    package:
      name: "rsync"
      state: present

  - name: fetch log files from {{ vitam_struct.vitam_component }}
    synchronize:
      mode: pull
      src: "{{ item.path }}"
      dest: "{{inventory_dir}}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.vitam_component }}/"
    with_items: "{{ path_files.files }}"

  when: sync_type == 'rsync'

- block:

  - name: create list
    set_fact: fichier="{{ item.path }}"
    with_items: "{{ path_files.files }}"
    register: filespath


  - name: Create a temp zip archive from files
    archive:
      path: "{{ filespath.results| map(attribute='ansible_facts.fichier') | list }}"
      dest: "{{ vitam_defaults.folder.root_path }}/tmp/{{ vitam_struct.vitam_component }}/{{ vitam_struct.vitam_component }}.zip"
      format: zip

  - name: fetch zip file from {{ vitam_struct.vitam_component }}
    fetch:
      src: "{{ vitam_defaults.folder.root_path }}/tmp/{{ vitam_struct.vitam_component }}/{{ vitam_struct.vitam_component }}.zip"
      dest: "{{inventory_dir}}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.vitam_component }}/{{ vitam_struct.vitam_component }}_{{ ansible_date_time.epoch }}.zip"
      flat: yes

  - name: remove temp zip file on host
    file:
      path: "{{ vitam_defaults.folder.root_path }}/tmp/{{ vitam_struct.vitam_component }}/{{ vitam_struct.vitam_component }}.zip"
      state: absent

  when: sync_type == 'fetch'
