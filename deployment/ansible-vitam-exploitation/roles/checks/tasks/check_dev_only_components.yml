---

- name: Check deployment mode
  fail:
    msg: "Invalid deployment mode. Expected values are 'prod' (default) or 'dev'"
  when: deployment_mode | default('prod') not in ['prod','dev']
  run_once: true

- block:

  - name: Ensure browser is disabled in production mode
    fail:
      msg: "browser deployment should not be enabled in production mode (browser.enabled must be set to false)"
    when: browser.enabled | default(false) | bool == true

  - name: Ensure ihm-recette is disabled in production mode
    fail:
      msg: "Ihm-recette deployment should not be enabled in production mode (hosts_ihm_recette group should be empty)"
    when: groups['hosts_ihm_recette'] | length > 0

  - name: Ensure kibana-data is disabled in production mode
    fail:
      msg: "Kibana-data deployment should not be enabled in production mode (hosts_kibana_data group should be empty)"
    when: groups['hosts_kibana_data'] | length > 0

  - name: Ensure dev tools is disabled in production mode
    fail:
      msg: "Dev tools (mongo-express / elasticsearch head plugins) deployment should not be enabled in production mode (hosts_dev_tools group should be empty)"
    when: groups['hosts_dev_tools'] | length > 0

  run_once: true
  when: deployment_mode | default('prod') != "dev"
