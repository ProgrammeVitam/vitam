---

- name: Diff_offers execution
  debug:
    msg: "Starting diff_offers for {{ item[0] }}_{{ item[1] }} between {{ offer1 }} and {{ offer2 }}"

- name: Calling API storage/v1/diff
  uri:
    url: "http://{{ ip_admin }}:{{vitam_struct.port_admin }}/storage/v1/diff"
    method: POST
    status_code: 200
    force_basic_auth: yes
    user: "{{ admin_basic_auth_user }}"
    password: "{{ admin_basic_auth_password }}"
    body: "{\"offer1\": \"{{ offer1 }}\",\"offer2\": \"{{ offer2 }}\",\"container\": \"{{ item[1] }}\",\"tenantId\": {{ item[0] }}}"
    body_format: json
    headers:
      Accept: application/json
      Content-Type: application/json

- name: Waiting for diff termination
  command: "curl -I --silent -u {{ admin_basic_auth_user }}:{{ admin_basic_auth_password }} -k -X HEAD http://{{ ip_admin }}:{{ vitam_struct.port_admin }}/storage/v1/diff"
  register: result
  until: "result.stdout.find(\"Running: false\") != -1"
  retries: "{{ nb_retries }}"
  delay: 60
  no_log: "{{ hide_passwords_during_deploy }}"

- name: Get diff status
  uri:
    method: GET
    status_code: 200
    force_basic_auth: yes
    user: "{{ admin_basic_auth_user }}"
    password: "{{ admin_basic_auth_password }}"
    url: "http://{{ ip_admin }}:{{vitam_struct.port_admin }}/storage/v1/diff"
    body_format: "json"
    return_content: true
    headers:
      Accept: application/json
  register: diff_status

- name: "Diff status: {{ diff_status.json.statusCode }}"
  debug:
    msg: "{{ diff_status.json }}"

- name: "Get report file locally under environments/offer_diff_reports/{{ offer1 }}_{{ offer2 }}/"
  fetch:
    src: "{{ diff_status.json.reportFileName }}"
    dest: "{{ inventory_dir }}/offer_diff_reports/{{ offer1 }}_{{ offer2 }}/{{ item[0] }}_{{ item[1] }}-{{ '%Y%m%d%H%M%S' | strftime }}-{{ diff_status.json.reportFileName | basename }}"
    flat: yes
  when: diff_status.json.statusCode == 'WARNING'
