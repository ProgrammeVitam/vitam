---

- block:
  - name: Ensure service is started
    service:
      name: "vitam-{{ vitam_struct.vitam_component }}"
      state: started

  - name: wait for service to be up'n'running on admin port
    wait_for:
      host: "{{ ip_admin }}"
      port: "{{ vitam_struct.port_admin }}"
      timeout: "{{ vitam_defaults.services.start_timeout }}"
    run_once: true

  - name: start diff
    uri:
      url: "http://{{ ip_admin }}:{{vitam_struct.port_admin }}/storage/v1/diff"
      method: POST
      status_code: 200
      force_basic_auth: yes
      user: "{{ admin_basic_auth_user }}"
      password: "{{ admin_basic_auth_password }}"
      body: "{\"offer1\": \"{{ offer1 }}\",\"offer2\": \"{{ offer2 }}\",\"container\": \"{{ container }}\",\"tenantId\": {{ tenantId }}}"
      body_format: "json"
      headers:
        Accept: application/json
        Content-Type: application/json

  - name: wait for diff termination
    command: "curl -I --silent -u {{ admin_basic_auth_user }}:{{ admin_basic_auth_password }} -k -X HEAD http://{{ ip_admin }}:{{ vitam_struct.port_admin }}/storage/v1/diff"
    register: result
    until: "result.stdout.find(\"Running: false\") != -1"
    retries: "{{ nb_retries }}"
    delay: 60
    no_log: "{{ hide_passwords_during_deploy }}"
    run_once: true

  - name: Get diff status
    uri:
      method: GET
      status_code: 200
      force_basic_auth: yes
      user: "{{ admin_basic_auth_user }}"
      password: "{{ admin_basic_auth_password }}"
      url: "http://{{ ip_admin }}:{{vitam_struct.port_admin }}/storage/v1/diff"
      body_format: "json"
      return_content: true
      headers:
        Accept: application/json
    run_once: true
    register: diff_status

  - debug: msg="Diff status {{ diff_status.json }}"

  - block:
    - name: Diff success
      debug:
        msg: "Diff status {{ diff_status.json.statusCode }}"

    when: diff_status.json.statusCode == 'OK'

  - block:
      - name: Diff failed
        fail:
          msg: "Diff failed with status {{ diff_status.json.statusCode }}"

    when: diff_status.json.statusCode != 'OK' and diff_status.json.statusCode != 'WARNING'

  - block:
      - name: Diff finished with warnings
        debug:
          msg: "Diff status {{ diff_status.json.statusCode }}"

      - name: Report file is...
        debug:
          msg: "{{ diff_status.json.reportFileName }}"

      - name: "Get report file locally in {{ inventory_dir }}/offer_diff_reports"
        fetch:
          src: "{{ diff_status.json.reportFileName }}"
          dest: "{{ inventory_dir }}/offer_diff_reports/{{ diff_status.json.reportFileName | basename }}"
          flat: yes

    when: diff_status.json.statusCode == 'WARNING'

  when: inventory_hostname == groups['hosts_storage_engine']|first
