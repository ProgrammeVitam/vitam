---

# Run variables checks
- name: Compute available_offers from vitam_strategy
  set_fact:
    available_offers: "{{ available_offers | default([]) + [ item.name+'.service.'+item.vitam_site_name | default(vitam_site_name)+'.'+consul_domain ] }}"
  loop: "{{ vitam_strategy }}"

- name: Check number of available offers
  fail:
    msg: "Less than 2 offers available. Could not run diff_offers on a single offer."
  when: available_offers | length < 2

- name: Automatic configuration of offer1 and offer2 when only 2 offers available
  set_fact:
    offer1: "{{ available_offers[0] }}"
    offer2: "{{ available_offers[1] }}"
  when: available_offers | length == 2

- name: available_offers
  debug:
    msg: "{{ available_offers }}"

- name: Check offer1
  assert:
    msg: "One or more condition is not valid for offer1 variable. Must be one of: {{ available_offers }}"
    that:
      - offer1 is defined
      - offer1 != ''
      - offer1 in available_offers

- name: Check offer2
  assert:
    msg: "One or more condition is not valid for offer2 variable. Must be one of: {{ available_offers | difference(offer1) }}"
    that:
      - offer2 is defined
      - offer2 != ''
      - offer2 != offer1
      - offer2 in available_offers

## Check tenants selection
- name: Check tenants
  assert:
    msg: "One or more condition is not valid for tenants variable."
    that:
      - tenants is defined
      - tenants is match('^[0-9]+[0-9,]*$')

- name: Set tenants as list
  set_fact:
    tenant_list: "{{ tenants.split(',') | map('int') | unique | list }}"

- name: Check tenant_list
  assert:
    msg: "The following tenants {{ tenant_list | difference(vitam_tenant_ids) }} {{ 'are' if tenant_list | difference(vitam_tenant_ids) | length > 1 else 'is' }} not valid. tenants variable must match the items in the following list: {{ vitam_tenant_ids }}"
    that:
      - tenant_list | difference(vitam_tenant_ids) | length == 0

## Check containers selection
- name: Check containers
  assert:
    msg: "One or more condition is not valid for tenants variable."
    that:
      - containers is defined
      - containers is match('^[a-z]+[a-z,]*$')

- name: Set containers as list
  set_fact:
    container_list: "{{ containers.split(',') | list }}"

- name: Check container_list
  assert:
    msg: "The following containers {{ container_list | difference(containers_list) }} {{ 'are' if container_list | difference(containers_list) | length > 1 else 'is' }} not valid. containers variable must match the items in the following list: {{ containers_list }}"
    that:
      - container_list | difference(containers_list) | length == 0

# Run service checks
- name: Ensure service is started
  service:
    name: "vitam-{{ vitam_struct.vitam_component }}"
    state: started

- name: wait for service to be up'n'running on admin port
  wait_for:
    host: "{{ ip_admin }}"
    port: "{{ vitam_struct.port_admin }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- name: Execute over elements from tenant_list and container_list
  include_tasks: exec_diff.yml
  loop: "{{ tenant_list | product(container_list) | list }}"
