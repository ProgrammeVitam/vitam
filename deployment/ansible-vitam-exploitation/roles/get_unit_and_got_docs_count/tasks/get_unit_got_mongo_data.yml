---

- name: Compute mongodb script to get docCount for Unit and ObjectGroup
  template:
    src: get_mongodata_doc_count.js.j2
    dest: "{{ vitam_defaults.folder.root_path }}/script/mongos/get_mongodata_doc_count.js"
    owner: "{{ vitam_defaults.users.vitam }}"
    group: "{{ vitam_defaults.users.group }}"
    mode: "{{ vitam_defaults.folder.conf_permission }}"

- name: Execute mongodb script and get the results
  shell: "mongo {{ ip_service }}:{{ mongodb.mongos_port }}/admin -u {{ mongodb[mongo_cluster_name].admin.user }} -p {{ mongodb[mongo_cluster_name].admin.password }} --quiet < {{ vitam_defaults.folder.root_path }}/script/mongos/get_mongodata_doc_count.js"
  register: out

- set_fact:
    unit_got_doc_count_mongo_data: "{{ out.stdout_lines | replace('switched to db metadata','') | trim | replace('\"','') }}"

- block:

  - name: Delete result file if it exists
    file:
      path: "{{ report_file }}"
      state: absent

  - name: Write header to result file
    lineinfile:
      line: "## Mongo-data Unit and ObjectGroup Doc count on {{ 'reference' if primary_site | lower == 'true' else 'reconstruction' }} site"
      path: "{{ report_file }}"
      create: true

  - name: Write output to result file
    lineinfile:
      line: "{{ item }}"
      path: "{{ report_file }}"
    when: item != ''
    with_items: "{{ unit_got_doc_count_mongo_data }}"

  delegate_to: localhost
