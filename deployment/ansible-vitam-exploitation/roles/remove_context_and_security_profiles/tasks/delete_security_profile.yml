---

- name: Check if security profile already exists in functional-admin
  uri:
    method: GET
    body: "{ \"$query\":{\"$eq\":{\"Identifier\":\"{{ item.identifier }}\"}},\"$filter\":{},\"$projection\":{} }"
    status_code: 200
    url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/v1/admin/securityprofiles"
    body_format: "json"
  run_once: true
  register: securityprofile_check

- name: Modify json & convert to dict...
  set_fact:
    securityprofile_check_json: "{{ securityprofile_check.json |regex_replace('\\$hits', 'hits')|regex_replace('\\$results', 'results')|regex_replace('\\#id', 'id') }}"
  run_once: true
- block:
  - name: Remove contexts of the security profile {{ item.identifier }}
    include_tasks: delete_certificates_contexts.yml
    loop : "{{ item.contexts }}"
    loop_control:
      loop_var: context

  - name: Delete security profile {{ item.identifier }}
    uri:
      method: DELETE
      status_code: 200,204
      url: "http://{{ hostvars[groups['hosts_functional_administration'][0]]['ip_admin'] }}:{{ vitam.functional_administration.port_admin }}/v1/admin/securityprofiles/{{ item.identifier }}"
    run_once: true
  when: securityprofile_check_json.hits.total > 0
