---
- block:
  - name: Copy the database scripts files
    copy:
      src: "{{ item }}"
      dest: "{{ vitam_defaults.folder.root_path }}/app/mongos/{{ item }}"
      owner: "{{ vitam_defaults.users.vitamdb }}"
      group: "{{ vitam_defaults.users.group }}"
      mode: "{{ vitam_defaults.folder.conf_permission }}"
      remote_src: false
    with_items:
      - "archive-unit-schema.json"
      - "checkInvalidUnits.js"

  - name: update contexts tenant directive directly in mongo
    command: "mongo {{ ip_service }}:{{ mongodb.mongos_port }}/metadata -u {{ mongodb[mongo_cluster_name].admin.user }} -p {{ mongodb[mongo_cluster_name].admin.password }} --quiet {{ vitam_defaults.folder.root_path }}/app/mongos/checkInvalidUnits.js"
    args:
      chdir: "{{ vitam_defaults.folder.root_path }}/app/mongos/"
    no_log: "{{ hide_passwords_during_deploy }}"
    run_once: true
    register: liste

  - name: display output
    debug:
      msg: "{{ liste.stdout }}"
    when:
      - liste.rc == 0

  - name: remove script files
    file:
      path: "{{ vitam_defaults.folder.root_path }}/app/mongos/{{ item }}"
      state: absent
    with_items:
      - "archive-unit-schema.json"
      - "checkInvalidUnits.js"

  # - name: display failures
  #   fail:
  #     msg: "{{ liste.stdout_lines }}"
  #   when:
  #     - liste.rc != 0

  when:
    - "mongo_cluster_name == 'mongo-data'"
