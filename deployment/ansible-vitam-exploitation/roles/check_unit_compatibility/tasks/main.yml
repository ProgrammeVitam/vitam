---

- name: Copy the database scripts files
  copy:
    src: "{{ item }}"
    dest: "{{ vitam_defaults.folder.root_path }}/script/mongos/{{ item }}"
    owner: "{{ vitam_defaults.users.vitamdb }}"
    group: "{{ vitam_defaults.users.group }}"
    mode: "{{ vitam_defaults.folder.conf_permission }}"
  with_items:
    - archive-unit-schema.json
    - checkInvalidUnits.js

- name: Check invalid units in metadata database
  command: "mongo {{ ip_service }}:{{ mongodb.mongos_port }}/metadata -u {{ mongodb[mongo_cluster_name].admin.user }} -p {{ mongodb[mongo_cluster_name].admin.password }} --quiet {{ vitam_defaults.folder.root_path }}/script/mongos/checkInvalidUnits.js"
  args:
    chdir: "{{ vitam_defaults.folder.root_path }}/script/mongos/"
  no_log: "{{ hide_passwords_during_deploy }}"
  register: output

- name: Display output
  debug:
    msg: "{{ output.stdout }}"

- name: Copy result to a file
  local_action:
    module: copy
    content: "{{ output.stdout }}"
    dest: "{{ inventory_dir }}/{{ vitam_site_name }}-InvalidUnits.json"
    backup: yes
