---

- name: "Remove old mongodb-org-tools (otherwise conflict with 5.0.x version)"
  package:
    name:
      - 'mongodb-org-tools'
    state: absent

- name: "Upgrade mongo packages"
  package:
    name:
      - 'mongodb-org'
      - 'mongodb-org-database-tools-extra'
      - 'mongodb-org-server'
      - 'mongodb-org-shell'
    state: latest

- name: "Upgrade vitam-mongoc"
  package:
    name:
      - 'vitam-mongoc'
    state: latest
  when: inventory_hostname in groups['hosts_mongoc_data'] or inventory_hostname in groups['hosts_mongoc_offer']

- name: "Upgrade vitam-mongod"
  package:
    name:
      - 'vitam-mongod'
    state: latest
  when: inventory_hostname in groups['hosts_mongod_data'] or inventory_hostname in groups['hosts_mongod_offer']
      
- name: "Upgrade vitam-mongos"
  package:
    name:
      - 'mongodb-org-mongos'
      - 'vitam-mongos'
    state: latest
  when: inventory_hostname in groups['hosts_mongos_data'] or inventory_hostname in groups['hosts_mongos_offer']

- name: "Start vitam-mongo service"
  systemd:
    name: "vitam-{{ item.svc }}"
    enabled: yes
    state: restarted
  with_items:
    - svc: 'mongos'
      when: inventory_hostname in groups['hosts_mongos_data'] or inventory_hostname in groups['hosts_mongos_offer']
    - svc: 'mongoc'
      when: inventory_hostname in groups['hosts_mongoc_data'] or inventory_hostname in groups['hosts_mongoc_offer']
    - svc: 'mongod'
      when: inventory_hostname in groups['hosts_mongod_data'] or inventory_hostname in groups['hosts_mongod_offer']

